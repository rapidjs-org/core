/**
 * rapidJS: Automatic serving, all-implicit-routing, pluggable fullstack scoped
 *          function modules, un-opinionated templating. 
 * 
 * Copyright (c) Thassilo Martin Schiepanski
 */
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PostEntity=void 0;const config_json_1=__importDefault(require("../../config.json")),config_server_1=__importDefault(require("../../config/evaluated")),output=__importStar(require("../../utilities/output")),ResponseError_1=require("../../interface/ResponseError/ResponseError"),endpoint_1=require("../../interface/plugin/endpoint"),Entity_1=require("./Entity");class PostEntity extends Entity_1.Entity{constructor(e,t){super(e,t)}localPath(){return super.localPath()+"."+config_json_1.default.dynamicFileExtension}process(){let r=!1;const n=[];this.req.on("data",e=>{r||(n.push(e),8*n.length<=config_server_1.default.limit.payloadSize||(this.respond(413),r=!0))}),this.req.on("end",()=>{r;let e;try{e=0<n.length?JSON.parse(n.toString()):null}catch(e){throw new SyntaxError(`Error parsing endpoint request body '${this.url.pathname}'`)}if(!(0,endpoint_1.has)(e.pluginName)&&!(0,endpoint_1.has)(e.pluginName,e.endpointName))return this.respond(404);this.processPagePath(),super.process();try{try{var t=(0,endpoint_1.use)(e.pluginName,e.body,e.endpointName);this.respond(200,t)}catch(e){if(e instanceof ResponseError_1.ResponseError)return this.respond(e.status,Buffer.from(JSON.stringify(e.message),"utf-8"));throw e}}catch(e){output.error(e),this.respond(e.status,e.message)}}),this.req.on("error",e=>{throw e})}}exports.PostEntity=PostEntity;