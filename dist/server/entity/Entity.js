/**
 * rapidJS: Automatic serving, all-implicit-routing, pluggable fullstack scoped
 *          function modules, un-opinionated templating. 
 * 
 * Copyright (c) Thassilo Martin Schiepanski
 */
"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Entity=void 0;const config_json_1=__importDefault(require("../../config.json")),fs_1=require("fs"),path_1=require("path"),url_1=require("url"),http_1=require("http"),config_server_1=__importDefault(require("../../config/evaluated")),tlds_json_1=__importDefault(require("../tlds.json")),locale_1=require("../../rendering/locale/locale");class Entity{constructor(e,t){this.cookies={received:{},set:{}},this.isCompound=!1,this.req=e,this.res=t,this.url=new url_1.URL(`${config_server_1.default.port.https?"https":"http"}://`+e.headers.host+e.url),this.originalPathname=this.url.pathname}getHeader(e){e=this.req.headers[e]||this.req.headers[e.toLowerCase()];return e?String(e):void 0}setHeader(e,t){this.res.setHeader(e,t)}pathnameToCompound(){return(0,path_1.join)((0,path_1.dirname)(this.url.pathname),""+config_json_1.default.compoundPageDirPrefix+(0,path_1.basename)(this.url.pathname).replace(/\.[a-z0-9]+$/i,""),(0,path_1.basename)(this.url.pathname))}pathnameToConventional(){return decodeURIComponent(this.url.pathname).replace(new RegExp(`/${config_json_1.default.compoundPageDirPrefix}([^/]+)/\\1$`),"/$1")}localPath(){return decodeURIComponent((0,path_1.join)(config_server_1.default.directory.web,this.url.pathname))}processPagePath(){if(this.url.pathname=this.url.pathname.replace(/\/$/,"/"+config_json_1.default.dynamicFileDefaultName),(0,fs_1.existsSync)(this.localPath()))return 200;var e=this.url.pathname;let t=0;const s=[];do{if(!/\/$/.test(this.url.pathname)){if(this.url.pathname=this.pathnameToCompound(),(0,fs_1.existsSync)(this.localPath()))return this.isCompound=!0,this.compoundArgs=s.reverse(),200;s.push((0,path_1.basename)(this.url.pathname)),this.url.pathname=(0,path_1.dirname)(this.url.pathname)}if(this.url.pathname=(0,path_1.join)((0,path_1.dirname)(this.url.pathname),config_json_1.default.dynamicFileDefaultName),this.url.pathname=this.pathnameToCompound(),(0,fs_1.existsSync)(this.localPath()))return this.isCompound=!0,this.compoundArgs=s.reverse(),200;if(this.url.pathname=(0,path_1.dirname)((0,path_1.dirname)(this.url.pathname)),t++,100<=t)return 408}while("/"!==this.url.pathname);return this.url.pathname=e,404}respond(e,t){t=t||Buffer.from(http_1.STATUS_CODES[String(e)],"utf-8");var s=!!config_server_1.default.port.https;this.setHeader("Server","rapidJS"),this.setHeader("X-XSS-Protection","1"),this.setHeader("X-Powered-By",null),this.setHeader("Content-Length",Buffer.byteLength(t,"utf-8")),s&&this.setHeader("Strict-Transport-Security",`max-age=${config_server_1.default.cachingDuration.client}; includeSubDomains`);const i=[];for(const a in this.cookies.set)i.push(`${a}=${this.cookies.set[a].value}; path=`+this.originalPathname+(this.cookies.set[a].maxAge?"; Max-Age="+this.cookies.set[a].maxAge:"")+(s?"; SameSite=Strict; Secure; HttpOnly":""));this.res.setHeader("Set-Cookie",i),this.res.statusCode=isNaN(e)?500:e,this.res.end(t)}redirect(e,t){this.url.pathname=e,t&&(this.url.hostname=t),this.res.setHeader("Location",this.url.toString()),this.res.statusCode=301,this.res.end()}process(){const e=this.getHeader("Cookie");e&&e.split(";").filter(e=>0<e.length).forEach(e=>{const t=e.split("=");this.cookies.received[t.shift().trim()]=decodeURI(t.join("="))});let t;const s=/([0-9]+(\.[0-9]+)*|(\.)?localhost)$/;if(s.test(this.url.hostname))t=this.url.hostname.replace(s,"");else{const i=this.url.hostname.match(/(\.[^.]+)?(\.[^.]+)$/);!tlds_json_1.default.includes(i[0].slice(1))&&i[1]&&(i[0]=i[2]),t=this.url.hostname.slice(0,-i[0].length)}if(this.subdomain=t.split(/\./g).filter(e=>0<e.length),locale_1.localeMatchRegex&&locale_1.defaultLang){this.locale={};const a=this.url.pathname.match(locale_1.localeMatchRegex);a&&(this.url.pathname=this.url.pathname.slice(a[0].length),this.locale.language=a[1].match(/^[a-z]{2}/)[0],this.locale.country=(a[1].match(/[A-Z]{2}$/)||[null])[0])}}getRequestObject(){return Object.assign({auth:this.getHeader("Authorization"),ip:this.getHeader("X-Forwarded-For")||this.req.connection.remoteAddress,locale:this.locale,pathname:decodeURIComponent(this.isCompound?(0,path_1.dirname)(this.url.pathname):this.url.pathname),subdomain:this.subdomain,cookies:{get:e=>this.cookies.set[e]?this.cookies.set[e].value:this.cookies.received[e],set:(e,t,s)=>{this.cookies.set[e]={value:t,maxAge:s}}},isCompound:this.isCompound},this.isCompound?{compound:{base:this.pathnameToConventional(),args:this.compoundArgs}}:{})}}exports.Entity=Entity;